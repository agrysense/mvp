/**
 * Test suite of the Camera operations defined in the DeviceManager class.
 * Note: avoid doing lengthy tests (split them in multiple scripts if this is the case)
 */

var jasmine = require("/tests/modules/jasmine/boot");
var deviceManagerModule = require("/agServerCore/entities/devices/deviceManager");
var init = require("../init");

var deviceManager = null; // Instance under testing
var controller = null; // reference controller

jasmine.describe("Testing the DeviceManager class", function() {

    jasmine.beforeAll(function(){
		 deviceManager = new deviceManagerModule.DeviceManager();
    }); 

    jasmine.beforeEach(function() {
       
        // create a reference controller
        var key = init.createController();
        controller = init.getDocument(key);
    });

    jasmine.it("deviceManager.listCameras() returns an array of 3 Camera instances", function() {
        
        // create 1 camera. Attention: the controller already ships with 1 camera
        var keys = [];
        for(var i = 0; i < 1; i++) {            
            keys[i] = init.createCamera(controller.key);
        }
        
        try {

            var list = deviceManager.listCameras();
            jasmine.expect(list).not.toBeNull(null);
            jasmine.expect(list.length).toBe(2);
            jasmine.expect(list[0].constructor.name).toBe("Camera");
            jasmine.expect(keys.indexOf(list[0].id)).not.toBeNull();
        }catch(exception){
            throw(JSON.stringify(exception));
        }finally {
            init.cleanup();   
        }
    });

    jasmine.it("deviceManager.getCamera() returns the requested camera instance", function() {

        try {

            key = init.createCamera(controller.key);
            var cameraData = init.getDocument(key);
            var camera = deviceManager.getCamera(key);
            jasmine.expect(camera).not.toBeNull(null);            
            jasmine.expect(camera.constructor.name).toBe("Camera");            
            jasmine.expect(camera.id).toBe(key);
            jasmine.expect(controller.key).toBe(camera.controller);           
        }catch(exception){
            throw(JSON.stringify(exception));
        }finally {
            init.cleanup();   
        }
    });

    jasmine.it("deviceManager.updateCamera() effectively updates the specified camera", function() {

        // create a camera
        try {

            var key = init.createCamera(controller.key);
            var cameraData = init.getDocument(key); 
            var camera = deviceManager.getCamera(key);
            camera.third_party = "mac";            
            deviceManager.updateCamera(camera.toJSONObject());     
            var updatedCameraData = init.getDocument(key);
            jasmine.expect(camera.third_party).toBe(updatedCameraData.third_party);  
            jasmine.expect(camera.controller).toBe(updatedCameraData.controller);           
        }catch(exception){
            throw(JSON.stringify(exception));
        }finally{
            init.cleanup();   
        }
    });
   
    jasmine.it("deviceManager.updateCamera() effectively creates a camera if no key provided", function() {

        // create camera data (not persisted)
        var cameraData = init.createCameraData(controller.key); 
       
        // remove the key
        delete cameraData.key;       
        try {

            var initCameraCount = init.listDocumentsOfType("Camera").length;
            
            // create a camera
            deviceManager.updateCamera(cameraData);
            var newCameraCount = init.listDocumentsOfType("Camera").length;
            jasmine.expect(newCameraCount).toBe(initCameraCount + 1);            
        }catch(exception){
            throw(JSON.stringify(exception));
        }finally {
            init.cleanup();   
        }
    });

    jasmine.it("deviceManager.deleteCamera() make sure that a camera is deleted from the store", function() {

        // create a camera
        var key = init.createCamera(controller.key);
        try {

            deviceManager.deleteCamera(key);
            try {
                
            	init.getDocument(key);                
                // if here fail
                it.fail();
            }catch(exception){
                // should reach this block
                jasmine.expect(true).toBe(true);   
            } 
        }catch(exception){
            throw(JSON.stringify(exception));
        }finally {
            init.cleanup();   
        }
    });

    jasmine.afterEach(function(){        

    });

    jasmine.afterAll(function(){        

    });
});

jasmine.execute();